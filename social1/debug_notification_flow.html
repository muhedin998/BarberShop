<!DOCTYPE html>
<html>
<head>
    <title>Notification Flow Debug</title>
    <meta name="user-authenticated" content="true">
    <meta name="csrf-token" content="debug-token">
</head>
<body class="authenticated">
    <h1>Notification Permission Flow Debug</h1>
    
    <div id="status">
        <h3>Status</h3>
        <p id="auth-status">Checking authentication...</p>
        <p id="fcm-status">Checking FCM Manager...</p>
        <p id="notification-handler-status">Checking Notification Handler...</p>
        <p id="permission-status">Checking permissions...</p>
        <p id="banner-status">Checking banner...</p>
    </div>
    
    <div id="controls">
        <h3>Manual Controls</h3>
        <button onclick="checkInitialization()">1. Check Initialization</button>
        <button onclick="testFCMManager()">2. Test FCM Manager</button>
        <button onclick="testNotificationHandler()">3. Test Notification Handler</button>
        <button onclick="requestPermissionManually()">4. Request Permission</button>
        <button onclick="checkTokens()">5. Check Backend Tokens</button>
    </div>
    
    <div id="log" style="background: #f0f0f0; padding: 10px; font-family: monospace; height: 400px; overflow-y: auto; margin-top: 20px;"></div>

    <!-- Load the actual Firebase and notification scripts -->
    <script src="/static/appointment/js/firebase-config.js"></script>
    <script src="/static/appointment/js/notification-permission.js"></script>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function updateStatus(elementId, message, success = null) {
            const element = document.getElementById(elementId);
            const color = success === true ? 'green' : success === false ? 'red' : 'blue';
            element.innerHTML = `<span style="color: ${color}">${message}</span>`;
        }

        async function checkInitialization() {
            log('=== Checking Initialization ===');
            
            // Check authentication
            const bodyHasAuthClass = document.body.classList.contains('authenticated');
            const metaTag = document.querySelector('meta[name="user-authenticated"]');
            const metaIsAuth = metaTag && metaTag.content === 'true';
            const isAuthenticated = bodyHasAuthClass || metaIsAuth;
            
            log(`Body has authenticated class: ${bodyHasAuthClass}`);
            log(`Meta tag user-authenticated: ${metaTag ? metaTag.content : 'not found'}`);
            log(`Final authentication status: ${isAuthenticated}`);
            updateStatus('auth-status', `Authenticated: ${isAuthenticated}`, isAuthenticated);
            
            // Check FCM Manager
            const fcmExists = typeof window.fcmManager !== 'undefined';
            const fcmInitialized = fcmExists && window.fcmManager.isInitialized;
            log(`FCM Manager exists: ${fcmExists}`);
            if (fcmExists) {
                log(`FCM Manager initialized: ${fcmInitialized}`);
                log(`FCM Manager supported: ${window.fcmManager.isSupported}`);
            }
            updateStatus('fcm-status', `FCM Manager: ${fcmExists ? (fcmInitialized ? 'Ready' : 'Not Ready') : 'Missing'}`, fcmInitialized);
            
            // Check Notification Handler
            const handlerExists = typeof window.notificationPermissionHandler !== 'undefined';
            log(`Notification Permission Handler exists: ${handlerExists}`);
            updateStatus('notification-handler-status', `Handler: ${handlerExists ? 'Loaded' : 'Missing'}`, handlerExists);
            
            // Check permissions
            const permission = Notification.permission;
            log(`Notification permission: ${permission}`);
            updateStatus('permission-status', `Permission: ${permission}`, permission === 'granted');
            
            // Check if banner should appear
            const bannerElement = document.getElementById('notification-permission-banner');
            const bannerExists = !!bannerElement;
            log(`Notification banner exists: ${bannerExists}`);
            updateStatus('banner-status', `Banner: ${bannerExists ? 'Visible' : 'Hidden'}`, null);
            
            if (handlerExists && window.notificationPermissionHandler) {
                const dismissed = window.notificationPermissionHandler.hasUserDismissedBanner();
                log(`User has dismissed banner: ${dismissed}`);
            }
        }

        async function testFCMManager() {
            log('=== Testing FCM Manager ===');
            
            if (!window.fcmManager) {
                log('FCM Manager not available', 'error');
                return;
            }
            
            log(`FCM Manager initialized: ${window.fcmManager.isInitialized}`);
            log(`FCM Manager supported: ${window.fcmManager.isSupported}`);
            log(`Current token: ${window.fcmManager.currentToken || 'none'}`);
            
            if (!window.fcmManager.isInitialized) {
                log('Attempting to initialize FCM Manager...');
                const success = await window.fcmManager.init();
                log(`FCM initialization result: ${success}`, success ? 'success' : 'error');
            }
        }

        async function testNotificationHandler() {
            log('=== Testing Notification Handler ===');
            
            if (!window.notificationPermissionHandler) {
                log('Notification handler not available', 'error');
                
                // Try to manually initialize it
                log('Attempting to manually initialize notification handler...');
                try {
                    window.notificationPermissionHandler = new NotificationPermissionHandler();
                    log('Notification handler created successfully', 'success');
                } catch (error) {
                    log(`Error creating notification handler: ${error.message}`, 'error');
                }
                return;
            }
            
            log('Notification handler is available', 'success');
            
            // Check if banner exists
            const banner = document.getElementById('notification-permission-banner');
            if (banner) {
                log('Notification banner found in DOM', 'success');
            } else {
                log('No notification banner in DOM', 'error');
                
                // Try to manually create banner
                log('Attempting to manually create banner...');
                try {
                    window.notificationPermissionHandler.createPermissionBanner();
                    log('Banner creation attempted', 'success');
                } catch (error) {
                    log(`Error creating banner: ${error.message}`, 'error');
                }
            }
        }

        async function requestPermissionManually() {
            log('=== Requesting Permission Manually ===');
            
            if (!window.notificationPermissionHandler) {
                log('Notification handler not available', 'error');
                return;
            }
            
            try {
                log('Calling notificationPermissionHandler.requestPermission()...');
                const result = await window.notificationPermissionHandler.requestPermission();
                log(`Permission request result: ${result}`, result ? 'success' : 'error');
                
                // Check if token was generated
                if (window.fcmManager && window.fcmManager.currentToken) {
                    log(`FCM token generated: ${window.fcmManager.currentToken.substring(0, 50)}...`, 'success');
                } else {
                    log('No FCM token generated', 'error');
                }
            } catch (error) {
                log(`Error requesting permission: ${error.message}`, 'error');
            }
        }

        async function checkTokens() {
            log('=== Checking Backend Tokens ===');
            
            try {
                const response = await fetch('/fcm/token-status/', {
                    method: 'GET',
                    headers: {
                        'X-CSRFToken': getCSRFToken()
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log(`Backend token count: ${data.count}`, 'success');
                    if (data.tokens && data.tokens.length > 0) {
                        data.tokens.forEach((token, index) => {
                            log(`Token ${index + 1}: Device ${token.device_id}, Created ${token.created_at}`);
                        });
                    }
                } else {
                    log(`Backend token check failed: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`Error checking backend tokens: ${error.message}`, 'error');
            }
        }

        function getCSRFToken() {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrftoken') {
                    return value;
                }
            }
            return 'debug-token';
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            log('Notification Flow Debug Page loaded');
            
            // Wait a bit for scripts to initialize
            setTimeout(() => {
                log('Running initial checks...');
                checkInitialization();
            }, 2000);
            
            // Check again after FCM ready event
            window.addEventListener('fcmReady', () => {
                log('FCM ready event received');
                setTimeout(checkInitialization, 1000);
            });
        });
    </script>
</body>
</html>