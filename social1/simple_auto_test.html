<!DOCTYPE html>
<html>
<head>
    <title>Simple Auto Token Test</title>
    <meta name="user-authenticated" content="true">
</head>
<body class="authenticated">
    <h1>Simple Automatic Token Generation Test</h1>
    
    <div>
        <button onclick="runTest()">Run Test</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>
    
    <div id="log" style="background: #f0f0f0; padding: 10px; font-family: monospace; height: 500px; overflow-y: auto; margin-top: 20px; white-space: pre-wrap;"></div>

    <script src="/static/appointment/js/firebase-config.js"></script>
    <script src="/static/appointment/js/notification-permission.js"></script>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        async function runTest() {
            log('=== STARTING AUTOMATIC TOKEN GENERATION TEST ===');
            
            // Step 1: Check permission
            log(`Step 1: Notification permission = ${Notification.permission}`);
            if (Notification.permission !== 'granted') {
                log('ERROR: Notifications not granted. Please allow notifications first.');
                return;
            }
            
            // Step 2: Check FCM Manager
            log(`Step 2: FCM Manager exists = ${!!window.fcmManager}`);
            if (!window.fcmManager) {
                log('ERROR: FCM Manager not loaded');
                return;
            }
            
            log(`Step 2b: FCM Manager initialized = ${window.fcmManager.isInitialized}`);
            
            // Step 3: Wait for FCM Manager to be ready if not already
            if (!window.fcmManager.isInitialized) {
                log('Step 3: Waiting for FCM Manager to initialize...');
                await new Promise(resolve => {
                    const check = () => {
                        if (window.fcmManager.isInitialized) {
                            log('Step 3: FCM Manager is now initialized');
                            resolve();
                        } else {
                            setTimeout(check, 100);
                        }
                    };
                    check();
                    
                    setTimeout(() => {
                        log('Step 3: Timeout waiting for FCM Manager');
                        resolve();
                    }, 10000);
                });
            }
            
            if (!window.fcmManager.isInitialized) {
                log('ERROR: FCM Manager failed to initialize');
                return;
            }
            
            // Step 4: Check for existing token
            log(`Step 4: Current token exists = ${!!window.fcmManager.currentToken}`);
            if (window.fcmManager.currentToken) {
                log(`Step 4: Existing token = ${window.fcmManager.currentToken.substring(0, 50)}...`);
                log('Token already exists, clearing it for test...');
                window.fcmManager.currentToken = null;
            }
            
            // Step 5: Generate token directly
            log('Step 5: Calling fcmManager.generateToken() directly...');
            try {
                const token = await window.fcmManager.generateToken();
                if (token) {
                    log(`Step 5: SUCCESS! Token generated = ${token.substring(0, 50)}...`);
                    log(`Step 5: Full token length = ${token.length}`);
                } else {
                    log('Step 5: FAILED! No token returned');
                }
            } catch (error) {
                log(`Step 5: ERROR! ${error.message}`);
                log(`Step 5: Error stack = ${error.stack}`);
            }
            
            // Step 6: Test via NotificationPermissionHandler
            log('Step 6: Testing via NotificationPermissionHandler...');
            if (window.notificationPermissionHandler) {
                log('Step 6: Handler exists, calling generateTokenForGrantedPermission()');
                try {
                    const result = await window.notificationPermissionHandler.generateTokenForGrantedPermission();
                    log(`Step 6: Handler result = ${result}`);
                } catch (error) {
                    log(`Step 6: Handler error = ${error.message}`);
                }
            } else {
                log('Step 6: NotificationPermissionHandler does not exist');
                
                // Try to create it manually
                log('Step 6b: Attempting to create NotificationPermissionHandler manually...');
                try {
                    const handler = new NotificationPermissionHandler();
                    log('Step 6b: Handler created successfully');
                } catch (error) {
                    log(`Step 6b: Error creating handler = ${error.message}`);
                }
            }
            
            log('=== TEST COMPLETE ===');
        }

        // Auto-run test after a delay
        setTimeout(() => {
            log('Auto-running test in 3 seconds...');
            setTimeout(runTest, 3000);
        }, 1000);
        
        // Also log when things initialize
        document.addEventListener('DOMContentLoaded', () => {
            log('DOM loaded');
        });
        
        window.addEventListener('fcmReady', () => {
            log('FCM Ready event received');
        });
    </script>
</body>
</html>