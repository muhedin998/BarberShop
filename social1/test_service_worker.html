<!DOCTYPE html>
<html>
<head>
    <title>Service Worker Test</title>
</head>
<body>
    <h1>Service Worker Debug</h1>
    
    <div id="status"></div>
    <br>
    <button onclick="testServiceWorker()">Test Firebase SW</button>
    <button onclick="testSimpleServiceWorker()">Test Simple SW</button>
    <button onclick="unregisterAll()">Unregister All</button>
    <br><br>
    <div id="log" style="background: #f0f0f0; padding: 10px; font-family: monospace; height: 400px; overflow-y: auto;"></div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        async function testServiceWorker() {
            log('=== Testing Service Worker ===');
            
            try {
                // Check if service worker is supported
                if (!('serviceWorker' in navigator)) {
                    log('ERROR: Service Worker not supported in this browser');
                    return;
                }
                
                log('Service Worker is supported');
                
                // Check current registrations
                const registrations = await navigator.serviceWorker.getRegistrations();
                log(`Current registrations: ${registrations.length}`);
                
                registrations.forEach((reg, index) => {
                    log(`Registration ${index + 1}:`);
                    log(`  - Scope: ${reg.scope}`);
                    log(`  - Active: ${!!reg.active}`);
                    log(`  - Installing: ${!!reg.installing}`);
                    log(`  - Waiting: ${!!reg.waiting}`);
                    if (reg.active) {
                        log(`  - State: ${reg.active.state}`);
                        log(`  - Script URL: ${reg.active.scriptURL}`);
                    }
                });
                
                // Test service worker URL accessibility
                const swUrl = `${window.location.origin}/firebase-messaging-sw.js`;
                log(`Testing service worker URL: ${swUrl}`);
                
                try {
                    const response = await fetch(swUrl);
                    log(`Service worker file status: ${response.status}`);
                    if (response.ok) {
                        const content = await response.text();
                        log(`Service worker file size: ${content.length} characters`);
                        if (content.includes('firebase')) {
                            log('✓ Service worker contains Firebase code');
                        } else {
                            log('⚠ Service worker does not contain Firebase code');
                        }
                    } else {
                        log('ERROR: Service worker file not accessible');
                    }
                } catch (fetchError) {
                    log(`ERROR fetching service worker: ${fetchError.message}`);
                }
                
                // Try to register service worker
                log('Attempting to register service worker...');
                
                try {
                    const registration = await navigator.serviceWorker.register(swUrl, {
                        scope: '/'
                    });
                    
                    log('✓ Service Worker registration successful');
                    log(`  - Scope: ${registration.scope}`);
                    log(`  - Update found: ${!!registration.update}`);
                    
                    // Wait for activation
                    if (registration.installing) {
                        log('Service worker is installing...');
                        registration.installing.addEventListener('statechange', function() {
                            log(`Service worker state: ${this.state}`);
                        });
                    }
                    
                    if (!registration.active) {
                        log('Waiting for service worker to become active...');
                        await new Promise((resolve) => {
                            const checkActive = () => {
                                if (registration.active) {
                                    log('✓ Service worker is now active');
                                    resolve();
                                } else {
                                    setTimeout(checkActive, 100);
                                }
                            };
                            checkActive();
                            
                            // Timeout after 10 seconds
                            setTimeout(() => {
                                log('⚠ Service worker activation timeout');
                                resolve();
                            }, 10000);
                        });
                    } else {
                        log('✓ Service worker is already active');
                    }
                    
                } catch (regError) {
                    log(`ERROR registering service worker: ${regError.message}`);
                    log(`Stack: ${regError.stack}`);
                }
                
                // Final status check
                const finalRegs = await navigator.serviceWorker.getRegistrations();
                const activeReg = finalRegs.find(reg => reg.active);
                
                if (activeReg) {
                    log('✓ FINAL STATUS: Active service worker found');
                    log(`  - Script: ${activeReg.active.scriptURL}`);
                    log(`  - State: ${activeReg.active.state}`);
                } else {
                    log('✗ FINAL STATUS: No active service worker');
                }
                
            } catch (error) {
                log(`UNEXPECTED ERROR: ${error.message}`);
                log(`Stack: ${error.stack}`);
            }
        }

        async function testSimpleServiceWorker() {
            log('=== Testing Simple Service Worker ===');
            
            try {
                const swUrl = `${window.location.origin}/static/test-sw.js`;
                log(`Registering simple service worker: ${swUrl}`);
                
                const registration = await navigator.serviceWorker.register(swUrl, {
                    scope: '/'
                });
                
                log('✓ Simple service worker registered');
                log(`  - Scope: ${registration.scope}`);
                
                // Wait for activation
                await new Promise((resolve) => {
                    if (registration.active) {
                        log('✓ Simple service worker is already active');
                        resolve();
                    } else {
                        log('Waiting for simple service worker activation...');
                        const worker = registration.installing || registration.waiting;
                        if (worker) {
                            worker.addEventListener('statechange', function() {
                                log(`Simple SW state: ${this.state}`);
                                if (this.state === 'activated') {
                                    log('✓ Simple service worker activated');
                                    resolve();
                                }
                            });
                        } else {
                            setTimeout(() => {
                                log('Simple SW activation timeout');
                                resolve();
                            }, 5000);
                        }
                    }
                });
                
                // Final check
                const finalRegs = await navigator.serviceWorker.getRegistrations();
                const activeReg = finalRegs.find(reg => reg.active);
                
                if (activeReg) {
                    log('✓ Final check: Active service worker found');
                    log(`  - Script: ${activeReg.active.scriptURL}`);
                } else {
                    log('✗ Final check: No active service worker');
                }
                
            } catch (error) {
                log(`ERROR with simple service worker: ${error.message}`);
            }
        }

        async function unregisterAll() {
            log('=== Unregistering All Service Workers ===');
            
            try {
                const registrations = await navigator.serviceWorker.getRegistrations();
                log(`Found ${registrations.length} registrations to unregister`);
                
                for (const registration of registrations) {
                    log(`Unregistering: ${registration.scope}`);
                    const success = await registration.unregister();
                    log(`  - ${success ? 'Success' : 'Failed'}`);
                }
                
                log('All service workers unregistered');
            } catch (error) {
                log(`Error unregistering: ${error.message}`);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            log('Service Worker Test Page loaded');
            log(`Origin: ${window.location.origin}`);
            log(`User Agent: ${navigator.userAgent}`);
        });
    </script>
</body>
</html>