{% extends 'appointment/zafrizera.html' %}
{% block opcije %}

<style>
    .modern-table {
        background: #1a1a1a;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
        margin: 2rem 0;
        border: 1px solid #333333;
    }
    
    .modern-table th {
        background: linear-gradient(135deg, #000000, #1c1c1c);
        color: #ffffff;
        padding: 1.3rem;
        font-weight: 700;
        font-size: 1.6rem;
        border: none;
        border-bottom: 2px solid #333333;
    }
    
    .modern-table td {
        padding: 1.3rem;
        border-bottom: 1px solid #333333;
        font-size: 1.4rem;
        vertical-align: middle;
        line-height: 1.5;
        background: #1a1a1a;
        color: #ffffff;
    }
    
    .modern-table tbody tr:hover {
        background-color: #2a2a2a !important;
    }
    
    .modern-table tbody tr:hover td {
        background-color: #2a2a2a;
        color: #ffffff;
    }
    
    .manage-btn {
        background: linear-gradient(135deg, #4a5568, #2d3748);
        color: #ffffff;
        border: 2px solid #718096;
        padding: 0.9rem 1.5rem;
        border-radius: 10px;
        cursor: pointer;
        font-size: 1.3rem;
        margin: 0 0.25rem;
        transition: all 0.3s ease;
        font-weight: 700;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .manage-btn:hover {
        background: linear-gradient(135deg, #718096, #4a5568);
        border-color: #a0aec0;
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.5);
        color: #f7fafc;
    }
    
    .manage-btn.danger {
        background: #dc2626;
        box-shadow: 0 2px 4px rgba(220, 38, 38, 0.3);
    }
    
    .manage-btn.danger:hover {
        background: #b91c1c;
        box-shadow: 0 4px 8px rgba(220, 38, 38, 0.4);
    }
    
    .manage-btn.success {
        background: #059669;
        box-shadow: 0 2px 4px rgba(5, 150, 105, 0.3);
    }
    
    .manage-btn.success:hover {
        background: #047857;
        box-shadow: 0 4px 8px rgba(5, 150, 105, 0.4);
    }
    
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }
    
    .modal-content {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
        transform: scale(0.9);
        transition: transform 0.3s ease;
    }
    
    .modal-overlay.show {
        display: flex;
    }
    
    .modal-overlay.show .modal-content {
        transform: scale(1);
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #e5e7eb;
    }
    
    .modal-title {
        margin: 0;
        color: #1f2937;
        font-size: 1.5rem;
        font-weight: 700;
    }
    
    .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #6b7280;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.3s ease;
    }
    
    .close-btn:hover {
        background: #f3f4f6;
        color: #374151;
    }
    
    .appointment-info {
        background: #f8fafc;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        border-left: 4px solid #3b82f6;
    }
    
    .appointment-info h4 {
        margin: 0 0 0.5rem 0;
        color: #1f2937;
        font-size: 1.2rem;
    }
    
    .appointment-info p {
        margin: 0.25rem 0;
        color: #6b7280;
    }
    
    .modal-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
    }
    
    .modal-btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        font-size: 1rem;
    }
    
    .modal-btn.primary {
        background: #3b82f6;
        color: white;
    }
    
    .modal-btn.primary:hover {
        background: #2563eb;
    }
    
    .modal-btn.danger {
        background: #ef4444;
        color: white;
    }
    
    .modal-btn.danger:hover {
        background: #dc2626;
    }
    
    .modal-btn.secondary {
        background: #6b7280;
        color: white;
    }
    
    .modal-btn.secondary:hover {
        background: #4b5563;
    }
    
    .pagination {
        background: white;
        padding: 1rem;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin: 1rem 0;
    }
    
    .btn-outline-primary {
        border-color: #3b82f6;
        color: #3b82f6;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        text-decoration: none;
        transition: all 0.3s ease;
    }
    
    .btn-outline-primary:hover {
        background: #3b82f6;
        color: white;
        text-decoration: none;
    }
    
    .cancelled-row {
        background-color: #7f1d1d !important;
        border-left: 4px solid #dc2626;
    }
    
    .cancelled-row td {
        background-color: #7f1d1d !important;
        color: #fca5a5 !important;
    }
    
    .cancelled-row:hover {
        background-color: #991b1b !important;
    }
    
    .cancelled-row:hover td {
        background-color: #991b1b !important;
        color: #fecaca !important;
    }
</style>

<!-- Pagination Controls -->
<div class="pagination d-flex justify-content-center align-items-center">
    {% if termini.has_previous %}
        <a href="?page=1" class="btn btn-outline-primary mx-1">
            <i class="fas fa-angle-double-left"></i> Prva
        </a>
        <a href="?page={{ termini.previous_page_number }}" class="btn btn-outline-primary mx-1">
            <i class="fas fa-angle-left"></i> Prethodna
        </a>
    {% endif %}

    <span class="mx-3 fw-bold text-primary">
        Strana {{ termini.number }} od {{ termini.paginator.num_pages }}
    </span>

    {% if termini.has_next %}
        <a href="?page={{ termini.next_page_number }}" class="btn btn-outline-primary mx-1">
            Sledeća <i class="fas fa-angle-right"></i>
        </a>
        <a href="?page={{ termini.paginator.num_pages }}" class="btn btn-outline-primary mx-1">
            Poslednja <i class="fas fa-angle-double-right"></i>
        </a>
    {% endif %}
</div>

<table class="modern-table w-100">
    <thead>
        <tr>
            {% if user.is_superuser %}
                <th>Mušterija</th>
            {% else %}
                <th>Frizer</th>
            {% endif %}
            <th>Usluga</th>
            <th>Datum & Vreme</th>
            {% if user.is_superuser %}
                <th>Akcije</th>
            {% endif %}
        </tr>
    </thead>
    <tbody>
        {% for usl in termini %}
            <tr {% if usl.name == "OTKAZAN DAN" %}class="cancelled-row"{% endif %}>
                {% if user.is_superuser %}
                    {% if usl.name == "OTKAZAN DAN" %}
                        <td colspan="2" class="text-center">
                            <strong>{{ usl.name }}</strong> - {{ usl.datum }}
                            <a href="{% url 'otkazivanje' usl.id %}" 
                               onclick="return confirm('Da li želite da otkažete termin?');"
                               class="manage-btn danger ms-2">
                                Otkaži <i class="fa-solid fa-xmark"></i>
                            </a>
                        </td>
                        <td></td>
                        <td></td>
                    {% else %}
                        <td>
                            <strong>{{ usl.name }}</strong><br>
                            <small class="text-muted">{{ usl.broj_telefona }}</small>
                        </td>
                    {% endif %}
                {% else %}
                    <td>{{ usl.frizer }}</td>
                {% endif %}
                
                {% if usl.name != "OTKAZAN DAN" %}
                    <td>
                        <strong>{{ usl.usluga.name }}</strong>
                        {% if usl.dodatne_usluge %}
                            <br><small class="text-muted">Dodatne usluge:</small>
                            <ul style="margin: 5px 0; padding-left: 20px;">
                            {% for dodatna_usluga in usl.dodatne_usluge_objekti %}
                                <li style="font-size: 0.9em;">{{ dodatna_usluga.name }}</li>
                            {% endfor %}
                            </ul>
                        {% endif %}
                    </td>
                    <td>
                        <strong>{{ usl.datum|date:"d.m.Y" }}</strong><br>
                        <small class="text-muted">{{ usl.vreme|time:"H:i" }}</small>
                    </td>
                    {% if user.is_superuser %}
                        <td>
                            <button class="manage-btn" onclick="openManageModal({{ usl.id }}, '{{ usl.name }}', '{{ usl.datum|date:"d.m.Y" }}', '{{ usl.vreme|time:"H:i" }}', '{{ usl.usluga.name }}')">
                                <i class="fas fa-cog"></i> Upravljaj
                            </button>
                        </td>
                    {% endif %}
                {% endif %}
            </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Pagination Controls (bottom) -->
<div class="pagination d-flex justify-content-center align-items-center">
    {% if termini.has_previous %}
        <a href="?page=1" class="btn btn-outline-primary mx-1">
            <i class="fas fa-angle-double-left"></i> Prva
        </a>
        <a href="?page={{ termini.previous_page_number }}" class="btn btn-outline-primary mx-1">
            <i class="fas fa-angle-left"></i> Prethodna
        </a>
    {% endif %}

    <span class="mx-3 fw-bold text-primary">
        Strana {{ termini.number }} od {{ termini.paginator.num_pages }}
    </span>

    {% if termini.has_next %}
        <a href="?page={{ termini.next_page_number }}" class="btn btn-outline-primary mx-1">
            Sledeća <i class="fas fa-angle-right"></i>
        </a>
        <a href="?page={{ termini.paginator.num_pages }}" class="btn btn-outline-primary mx-1">
            Poslednja <i class="fas fa-angle-double-right"></i>
        </a>
    {% endif %}
</div>

{% if user.is_superuser %}
<!-- Management Modal -->
<div id="manageModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Upravljanje terminom</h3>
            <button class="close-btn" onclick="closeManageModal()">&times;</button>
        </div>
        
        <div class="appointment-info">
            <h4 id="modalCustomerName"></h4>
            <p><strong>Datum:</strong> <span id="modalDate"></span></p>
            <p><strong>Vreme:</strong> <span id="modalTime"></span></p>
            <p><strong>Usluga:</strong> <span id="modalService"></span></p>
        </div>
        
        <p style="color: #6b7280; margin-bottom: 1.5rem;">
            Šta želite da uradite sa ovim terminom?
        </p>
        
        <div class="modal-actions">
            <button class="modal-btn secondary" onclick="closeManageModal()">
                Otkaži
            </button>
            <form id="manageForm" method="post" style="display: inline;">
                {% csrf_token %}
                <input type="hidden" name="action" id="modalAction">
                <button type="button" class="modal-btn primary" onclick="submitAction('mark_completed')">
                    ✓ Termin završen
                </button>
                <button type="button" class="modal-btn danger" onclick="submitAction('delete')">
                    🗑️ Mušterija nije došla
                </button>
            </form>
        </div>
    </div>
</div>

<script>
let currentTerminId = null;

function openManageModal(terminId, customerName, date, time, service) {
    currentTerminId = terminId;
    document.getElementById('modalCustomerName').textContent = customerName;
    document.getElementById('modalDate').textContent = date;
    document.getElementById('modalTime').textContent = time;
    document.getElementById('modalService').textContent = service;
    
    const modal = document.getElementById('manageModal');
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
}

function closeManageModal() {
    const modal = document.getElementById('manageModal');
    modal.classList.remove('show');
    document.body.style.overflow = 'auto';
    currentTerminId = null;
}

function submitAction(action) {
    if (!currentTerminId) return;
    
    const actionText = action === 'delete' ? 
        'obrisati termin (mušterija nije došla)' : 
        'označiti termin kao završen';
    
    if (confirm(`Da li ste sigurni da želite da ${actionText}?`)) {
        document.getElementById('modalAction').value = action;
        const form = document.getElementById('manageForm');
        form.action = `/manage_appointment/${currentTerminId}/`;
        form.submit();
    }
}

// Close modal when clicking outside
document.getElementById('manageModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeManageModal();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeManageModal();
    }
});
</script>
{% endif %}

{% endblock %}