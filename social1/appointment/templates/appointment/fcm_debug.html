{% extends 'appointment/base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <h2>FCM Debug Page</h2>
    <div class="card">
        <div class="card-body">
            <h5>Firebase FCM Token Debug</h5>
            
            <div id="debug-info">
                <p><strong>Current Permission:</strong> <span id="permission-status">Checking...</span></p>
                <p><strong>FCM Manager Status:</strong> <span id="fcm-status">Checking...</span></p>
                <p><strong>Service Worker:</strong> <span id="sw-status">Checking...</span></p>
                <p><strong>Current Token:</strong> <span id="current-token">None</span></p>
            </div>
            
            <div class="mt-3">
                <button id="check-status" class="btn btn-info">Check Status</button>
                <button id="request-permission" class="btn btn-warning">Request Permission</button>
                <button id="get-token" class="btn btn-success">Get FCM Token</button>
            </div>
            
            <div class="mt-3">
                <h6>Debug Log:</h6>
                <div id="debug-log" style="background: #f8f9fa; padding: 10px; border-radius: 5px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                    <!-- Debug messages will appear here -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Debug logging function
function debugLog(message) {
    const logDiv = document.getElementById('debug-log');
    const timestamp = new Date().toLocaleTimeString();
    logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
    logDiv.scrollTop = logDiv.scrollHeight;
    console.log(`[FCM Debug] ${message}`);
}

// Update status display
function updateStatus() {
    // Permission status
    document.getElementById('permission-status').textContent = Notification.permission;
    
    // FCM Manager status
    if (window.fcmManager) {
        document.getElementById('fcm-status').textContent = `Initialized: ${window.fcmManager.isInitialized}, Supported: ${window.fcmManager.isSupported}`;
        document.getElementById('current-token').textContent = window.fcmManager.currentToken || 'None';
    } else {
        document.getElementById('fcm-status').textContent = 'Not available';
    }
    
    // Service Worker status
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(registrations => {
            document.getElementById('sw-status').textContent = `${registrations.length} registered`;
        });
    } else {
        document.getElementById('sw-status').textContent = 'Not supported';
    }
}

// Event handlers
document.getElementById('check-status').addEventListener('click', () => {
    debugLog('=== Checking Status ===');
    updateStatus();
    debugLog(`Notification permission: ${Notification.permission}`);
    debugLog(`FCM Manager available: ${!!window.fcmManager}`);
    if (window.fcmManager) {
        debugLog(`FCM Manager initialized: ${window.fcmManager.isInitialized}`);
        debugLog(`FCM Manager supported: ${window.fcmManager.isSupported}`);
        debugLog(`Current token: ${window.fcmManager.currentToken || 'None'}`);
    }
});

document.getElementById('request-permission').addEventListener('click', async () => {
    debugLog('=== Requesting Permission ===');
    
    if (!window.fcmManager) {
        debugLog('ERROR: FCM Manager not available');
        return;
    }
    
    try {
        const token = await window.fcmManager.requestPermission();
        debugLog(`Permission request result: ${token ? 'SUCCESS' : 'FAILED'}`);
        if (token) {
            debugLog(`Token: ${token.substring(0, 50)}...`);
        }
        updateStatus();
    } catch (error) {
        debugLog(`ERROR requesting permission: ${error.message}`);
    }
});

document.getElementById('get-token').addEventListener('click', async () => {
    debugLog('=== Getting FCM Token ===');
    
    if (!window.fcmManager) {
        debugLog('ERROR: FCM Manager not available');
        return;
    }
    
    try {
        const token = await window.fcmManager.generateToken();
        debugLog(`Token generation result: ${token ? 'SUCCESS' : 'FAILED'}`);
        if (token) {
            debugLog(`Token: ${token.substring(0, 50)}...`);
        }
        updateStatus();
    } catch (error) {
        debugLog(`ERROR getting token: ${error.message}`);
    }
});

// Initialize when page loads
document.addEventListener('DOMContentLoaded', () => {
    debugLog('FCM Debug page loaded');
    updateStatus();
    
    // Wait a bit for FCM Manager to initialize
    setTimeout(() => {
        debugLog('Checking FCM Manager after delay...');
        updateStatus();
    }, 2000);
});
</script>
{% endblock %}