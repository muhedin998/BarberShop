{% extends "appointment/base.html" %}
{% block content %}
<br>
<br>
<br>
<br>
<h3 class="w3-center">ZAKAZIVANJE TERMINA </h3><br>
{% if messages %}

    {% for message in messages %}
    <p class="w3-center p-2 text-white bg-opacity-75 fs-1 bg-{{ message.tags }}">{{ message }}</p>
    {% endfor %}

{% endif %}

    <div class="loyalty-info-container">
        {% if "BESPLATAN" in termin_counter %}
            <div class="loyalty-badge free-next">
                {{ termin_counter }}
            </div>
        {% elif "1 termin do" in termin_counter %}
            <div class="loyalty-badge almost-free">
                {{ termin_counter }}
            </div>
        {% else %}
            <div class="loyalty-badge regular">
                {{ termin_counter }}
            </div>
        {% endif %}
    </div>

    <div class="mb-3 row justify-content-center ">
    <br>

    <br>
    <div class="col-md-auto col-sm-auto col-lg-4 shadow-lg p-3 mb-5 bg-body rounded {% if viewname != "termin" %}w3-hide{% endif %}" id="prva-forma" >

        <form method="post" class="w3-margin">
            {% csrf_token %}
            <label>Glavna usluga: </label>
            <!-- Hidden actual select for form submission -->
            <select name="usluga" required="required" id="id_usluga" style="display: none;">
                <option selected disabled value=""></option>
                {% with value=form.usluga.value %}
                {% for value in form.usluga.field.choices.queryset %}
                <option title="{{value}}" value="{{ value.id }}"{% if value.id == 15 or value.id == 14 or value.id == 13 %}disabled{% endif %}>{{ value }}</option>
                {% endfor %}
                {% endwith %}
            </select>
            
            <!-- Custom dropdown for Usluga -->
            <div class="custom-select-container">
                <div class="custom-select-trigger" id="usluga-trigger" onclick="toggleDropdown('usluga')">
                    <span id="usluga-selected">Izaberite uslugu...</span>
                    <div class="custom-select-arrow">
                        <i class="fa fa-chevron-down"></i>
                    </div>
                </div>
                <div class="custom-select-backdrop" id="usluga-backdrop" onclick="closeDropdown('usluga')"></div>
                <div class="custom-select-dropdown" id="usluga-dropdown">
                    <div class="dropdown-header">
                        <h4 class="dropdown-title">Izaberite uslugu</h4>
                        <button class="dropdown-close" onclick="closeDropdown('usluga')" type="button">
                            <i class="fa fa-times"></i>
                        </button>
                    </div>
                    {% for value in form.usluga.field.choices.queryset %}
                    {% if value.id != 15 and value.id != 14 and value.id != 13 %}
                    <div class="custom-select-option" data-value="{{ value.id }}" onclick="selectOption('usluga', '{{ value.id }}', '{{ value }}')">
                        <div class="option-content">
                            <div class="option-left">
                                <div class="option-avatar service-avatar">
                                    {% if value.slika %}
                                        <img src="{{ value.slika.url }}" alt="{{ value.name }}" class="avatar-image">
                                    {% else %}
                                        <i class="fa fa-scissors"></i>
                                    {% endif %}
                                </div>
                                <div class="option-info">
                                    <span class="option-name">{{ value }}</span>
                                    <span class="option-duration">{% if value.duzina %}{% widthratio value.duzina.total_seconds 60 1 %}{% else %}30{% endif %} min</span>
                                </div>
                            </div>
                            <div class="option-right">
                                <span class="option-price">{{ value.cena }} RSD</span>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
                
                <div id="dodaj-uslugu-section" style="display: none; margin-top: 15px;">
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="dodaj-uslugu-btn" onclick="dodajUsluguSelect()">
                        <i class="fa fa-plus"></i> Dodaj dodatnu uslugu
                    </button>
                </div>
                
                <div id="dodatne-usluge-container">
                    <!-- Dodatni select-ovi za usluge će se dodavati ovde -->
                </div>
                
                <div id="cene-pregled" style="display: none; margin-top: 15px; background-color: #f8f9fa; padding: 10px; border-radius: 5px;">
                    <strong>Pregled cena:</strong>
                    <div id="glavna-usluga-cena"></div>
                    <div id="dodatne-usluge-cene"></div>
                    <hr style="margin: 10px 0;">
                    <div id="ukupna-cena" style="font-weight: bold; color: #007bff;"></div>
                </div>
                <br>
                <label><br>Izaberite frizera: </label>
                <!-- Hidden actual select for form submission -->
                <select name="frizer" required="required" id="id_frizer" style="display: none;">
                    <option selected disabled value=""></option>
                    {% with value=form.frizer.value %}
                    {% for value in form.frizer.field.choices.queryset %}
                        {% if value.id == 4 %}
                            {% if user.is_superuser %}
                                <option title="{{ value }}" value="{{ value.id }}">{{ value }}</option>
                            {% endif %}
                        {% else %}
                            <option title="{{ value }}" value="{{ value.id }}">{{ value }}</option>
                        {% endif %}
                    {% endfor %}
                    {% endwith %}
                </select>
                
                <!-- Custom dropdown for Frizer -->
                <div class="custom-select-container">
                    <div class="custom-select-trigger" id="frizer-trigger" onclick="toggleDropdown('frizer')">
                        <span id="frizer-selected">Izaberite frizera...</span>
                        <div class="custom-select-arrow">
                            <i class="fa fa-chevron-down"></i>
                        </div>
                    </div>
                    <div class="custom-select-backdrop" id="frizer-backdrop" onclick="closeDropdown('frizer')"></div>
                    <div class="custom-select-dropdown" id="frizer-dropdown">
                        <div class="dropdown-header">
                            <h4 class="dropdown-title">Izaberite frizera</h4>
                            <button class="dropdown-close" onclick="closeDropdown('frizer')" type="button">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                        {% for value in form.frizer.field.choices.queryset %}
                        {% if value.id == 4 %}
                            {% if user.is_superuser %}
                            <div class="custom-select-option" data-value="{{ value.id }}" onclick="selectOption('frizer', '{{ value.id }}', '{{ value }}')">
                                <div class="option-content">
                                    <div class="option-left">
                                        <div class="option-avatar barber-avatar">
                                            {% if value.image %}
                                                <img src="{{ value.image.url }}" alt="{{ value.name }}" class="avatar-image">
                                            {% else %}
                                                <span class="avatar-initials">{{ value.name|slice:":2"|upper }}</span>
                                            {% endif %}
                                        </div>
                                        <div class="option-info">
                                            <span class="option-name">{{ value }}</span>
                                            <span class="option-status">Admin - Dostupan</span>
                                        </div>
                                    </div>
                                    <div class="option-right">
                                        <span class="option-badge admin-badge">Admin</span>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        {% else %}
                        <div class="custom-select-option" data-value="{{ value.id }}" onclick="selectOption('frizer', '{{ value.id }}', '{{ value }}')">
                            <div class="option-content">
                                <div class="option-left">
                                    <div class="option-avatar barber-avatar">
                                        {% if value.image %}
                                            <img src="{{ value.image.url }}" alt="{{ value.name }}" class="avatar-image">
                                        {% else %}
                                            <span class="avatar-initials">{{ value.name|slice:":2"|upper }}</span>
                                        {% endif %}
                                    </div>
                                    <div class="option-info">
                                        <span class="option-name">{{ value }}</span>
                                        <span class="option-status">Sledeći slobodan: {% for frizer_info in frizeri_with_slots %}{% if frizer_info.frizer.id == value.id %}{{ frizer_info.next_free_slot }}{% endif %}{% endfor %}</span>
                                    </div>
                                </div>
                                <div class="option-right">
                                    <span class="option-badge barber-badge">Frizer</span>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
                <label><br>Izaberite datum: </label><br>
                <input required style=" padding: 20 5; width: 100%; margin-bottom: 4px;" class="w3-select" type="date" name="datum" id="datum" min="{{ min_date }}" max="{{ max_date }}" style="border: none; "><br>
                <small class="text-muted">Možete zakazati termin maksimalno 30 dana unapred</small><br><br>
                
                
            <button class="btn btn-secondary"  name="form_filter_button"  id="first_form_button" style="-webkit-appearance: none;">Izaberite termin <i class="fa fa-arrow-right"></i></button>
        </form>
        <br>

    </div>

    <div class="col-md-auto col-sm-auto col-lg-4 shadow-lg p-3 mb-5 bg-body rounded {% if viewname != "potvrdi" %}w3-hide{% endif %}" id="druga-forma">
        <form class="w3-margin" action="" method="post" id="potvrdi-form">


            {% csrf_token %}
            {% if user.is_superuser %} 
                <label>Ime i Prezime: </label><br>
                <input required style=" padding: 20 5; width: 100%; margin-bottom: 4px;" class="w3-select" type="text" name="name" >

                <label>Broj telefona: </label><br>
                <input required style=" padding: 20 5; width: 100%; margin-bottom: 4px;" class="w3-select" type="text" name="broj_telefona" > 
            {% endif %}

            {% if has_multiple_services %}
            <div class="alert alert-info">
                <strong>Odabrane usluge:</strong>
                <ul style="margin-bottom: 10px;">
                {% for service in all_services %}
                    <li>
                        {% if service.is_main %}
                            <strong>{{ service.name }}</strong> (glavna) - {{ service.price }} RSD
                        {% else %}
                            {{ service.name }} (dodatna) - {{ service.price }} RSD
                        {% endif %}
                    </li>
                {% endfor %}
                </ul>
                <small class="text-muted">Vreme termina se računa samo za glavnu uslugu.</small>
            </div>
            {% elif glavna_usluga_info %}
            <div class="alert alert-info">
                <strong>Odabrana usluga:</strong> {{ glavna_usluga_info.name }} - {{ glavna_usluga_info.cena }} RSD
            </div>
            {% endif %}
            
            {% if ukupna_cena %}
            <div class="alert alert-success">
                <strong>Ukupna cena termina: {{ ukupna_cena }} RSD</strong>
            </div>
            {% endif %}
            
            <label>Izaberite termin: </label><br>
            {{ form.vreme }}
            <label class="mt-2">Ostavite poruku: <span style="opacity: 0.5;">(opciono)</span></label><br>
            
            {{ form.poruka }}
            <br>
            <div class="row mt-3">
            <div class="col">
            <input style=" padding: 20 5; width: 100%; margin-bottom: 4px;" class="btn btn-success" name="zakazi_termin" type="submit" value="ZAKAŽI">
            </div>
            <div class="col">
            <a href="{% url 'termin' %}" class="btn"> <i class="fa fa-arrow-left"> </i> Izmena unosa</a>
            </div>
            </div>
        </form>
        <div style="display:none;" id="nema-termina">
            <h1 class="bg-secondary w3-padding text-white" >Nema dostupnih termina za ovaj dan !</h1>
            <br>
            <a href="{% url 'termin' %}" class="btn btn-secondary"> <i class="fa fa-arrow-left"> </i> Promeni datum</a>
        </div>
  </div>
</div>
<br><br><br>

<script>
    const picker = document.getElementById('datum');
    picker.addEventListener('input', function(e){
        var day = new Date(this.value).getUTCDay();
        if([5].includes(day)){
            e.preventDefault();
            picker.value = getNextMonday(this.value).toISOString().substring(0,10);
            alert('Petkom ne radimo ! \n');
        }
    });

    function getNextMonday(value) {
        date = new Date(value)
        const dateCopy = new Date(date.getTime());

        const nextMonday = new Date(dateCopy.setDate(dateCopy.getDate() + 1));
        return nextMonday;
    }

    let dodatneUslugeCount = 0;
    const MAX_DODATNE_USLUGE = 3;
    let uslugeData = {}; // Object to store service data (id -> {name, price})

    // Initialize service data from the Django template data
    function inicijalizujUslugeData() {
        // Initialize with data from Django template
        uslugeData = {
            {% for value in form.usluga.field.choices.queryset %}
            {% if value.id != 15 and value.id != 14 and value.id != 13 %}
            '{{ value.id }}': {
                name: '{{ value.name|escapejs }}',
                price: {{ value.cena }},
                duration: {% if value.duzina %}{% widthratio value.duzina.total_seconds 60 1 %}{% else %}30{% endif %},
                slika: {% if value.slika %}'{{ value.slika.url }}'{% else %}null{% endif %}
            }{% if not forloop.last %},{% endif %}
            {% endif %}
            {% endfor %}
        };
        
        // Make it globally available
        window.uslugeData = uslugeData;
    }

    // Update price display
    function azurirajCene() {
        const glavnaUsluga = document.getElementById('id_usluga').value;
        const cenePregled = document.getElementById('cene-pregled');
        const glavnaUslugaCena = document.getElementById('glavna-usluga-cena');
        const dodatneUslugeCene = document.getElementById('dodatne-usluge-cene');
        const ukupnaCena = document.getElementById('ukupna-cena');
        
        if (!glavnaUsluga || !cenePregled) {
            if (cenePregled) cenePregled.style.display = 'none';
            return;
        }
        
        let ukupno = 0;
        let hasAdditionalServices = false;
        
        // Display main service price
        if (uslugeData[glavnaUsluga]) {
            glavnaUslugaCena.innerHTML = `<strong>Glavna usluga:</strong> ${uslugeData[glavnaUsluga].name} - ${uslugeData[glavnaUsluga].price} RSD`;
            ukupno += uslugeData[glavnaUsluga].price;
        }
        
        // Display additional services prices
        dodatneUslugeCene.innerHTML = '';
        const dodatneUslugeSelects = document.querySelectorAll('[id^=\"dodatna_usluga_\"]');
        let additionalServicesHTML = '';
        
        dodatneUslugeSelects.forEach((select, index) => {
            if (select.value && uslugeData[select.value]) {
                additionalServicesHTML += `<div>Dodatna usluga ${index + 1}: ${uslugeData[select.value].name} - ${uslugeData[select.value].price} RSD</div>`;
                ukupno += uslugeData[select.value].price;
                hasAdditionalServices = true;
            }
        });
        
        if (hasAdditionalServices) {
            dodatneUslugeCene.innerHTML = '<strong>Dodatne usluge:</strong><br>' + additionalServicesHTML;
        }
        
        // Display total with emphasis
        ukupnaCena.innerHTML = `<strong style="color: #28a745; font-size: 1.1em;">UKUPNA CENA: ${ukupno} RSD</strong>`;
        cenePregled.style.display = ukupno > 0 ? 'block' : 'none';
    }

    function pokaziDodajUsluguDugme() {
        const glavnaUsluga = document.getElementById('id_usluga').value;
        const dugmeSection = document.getElementById('dodaj-uslugu-section');
        
        if (glavnaUsluga) {
            dugmeSection.style.display = 'block';
        } else {
            dugmeSection.style.display = 'none';
            // Ukloni sve dodatne usluge ako se glavna usluga promeni
            const container = document.getElementById('dodatne-usluge-container');
            container.innerHTML = '';
            dodatneUslugeCount = 0;
            azurirajDugme();
        }
        azurirajCene(); // Update prices when main service changes
    }

    function createCustomSelectForAdditional(selectId) {
        // Create custom select container
        const customSelectContainer = document.createElement('div');
        customSelectContainer.className = 'custom-select-container';
        customSelectContainer.style.flex = '1';
        customSelectContainer.style.marginBottom = '0';
        
        // Create custom select trigger
        const customSelectTrigger = document.createElement('div');
        customSelectTrigger.className = 'custom-select-trigger';
        customSelectTrigger.id = `${selectId}-trigger`;
        customSelectTrigger.onclick = () => toggleDropdown(selectId);
        
        const selectedSpan = document.createElement('span');
        selectedSpan.id = `${selectId}-selected`;
        selectedSpan.textContent = 'Izaberite dodatnu uslugu...';
        
        const arrowDiv = document.createElement('div');
        arrowDiv.className = 'custom-select-arrow';
        arrowDiv.innerHTML = '<i class="fa fa-chevron-down"></i>';
        
        customSelectTrigger.appendChild(selectedSpan);
        customSelectTrigger.appendChild(arrowDiv);
        
        // Create backdrop
        const customSelectBackdrop = document.createElement('div');
        customSelectBackdrop.className = 'custom-select-backdrop';
        customSelectBackdrop.id = `${selectId}-backdrop`;
        customSelectBackdrop.onclick = () => closeDropdown(selectId);
        
        // Create custom select dropdown
        const customSelectDropdown = document.createElement('div');
        customSelectDropdown.className = 'custom-select-dropdown';
        customSelectDropdown.id = `${selectId}-dropdown`;
        
        // Create dropdown header
        const dropdownHeader = document.createElement('div');
        dropdownHeader.className = 'dropdown-header';
        
        const dropdownTitle = document.createElement('h4');
        dropdownTitle.className = 'dropdown-title';
        dropdownTitle.textContent = 'Izaberite dodatnu uslugu';
        
        const closeButton = document.createElement('button');
        closeButton.className = 'dropdown-close';
        closeButton.type = 'button';
        closeButton.innerHTML = '<i class="fa fa-times"></i>';
        closeButton.onclick = () => closeDropdown(selectId);
        
        dropdownHeader.appendChild(dropdownTitle);
        dropdownHeader.appendChild(closeButton);
        customSelectDropdown.appendChild(dropdownHeader);
        
        // Create options from the main select element (same data source)
        const mainSelect = document.getElementById('id_usluga');
        const mainOptions = mainSelect.querySelectorAll('option');
        
        mainOptions.forEach(option => {
            if (!option.value || option.disabled) return; // Skip empty and disabled options
            
            const serviceId = option.value;
            const serviceName = option.textContent.trim();
            
            // Skip disabled services
            if (serviceId === '13' || serviceId === '14' || serviceId === '15') return;
            
            const customOption = document.createElement('div');
            customOption.className = 'custom-select-option';
            customOption.setAttribute('data-value', serviceId);
            customOption.onclick = () => selectOptionAdditional(selectId, serviceId, serviceName);
            
            // Get service data if available, otherwise use defaults
            const serviceData = window.uslugeData && window.uslugeData[serviceId];
            const duration = serviceData ? serviceData.duration : '30'; // default duration
            const price = serviceData ? serviceData.price : '0'; // will be updated by price calculation
            
            // Get service data including image
            const hasImage = serviceData && serviceData.slika;
            const imageHtml = hasImage ? 
                `<img src="${serviceData.slika}" alt="${serviceName}" class="avatar-image">` : 
                `<i class="fa fa-scissors"></i>`;
            
            customOption.innerHTML = `
                <div class="option-content">
                    <div class="option-left">
                        <div class="option-avatar service-avatar">
                            ${imageHtml}
                        </div>
                        <div class="option-info">
                            <span class="option-name">${serviceName}</span>
                            <span class="option-duration">${duration} min</span>
                        </div>
                    </div>
                    <div class="option-right">
                        <span class="option-price">${price} RSD</span>
                    </div>
                </div>
            `;
            customSelectDropdown.appendChild(customOption);
        });
        
        // Assemble custom select
        customSelectContainer.appendChild(customSelectTrigger);
        customSelectContainer.appendChild(customSelectBackdrop);
        customSelectContainer.appendChild(customSelectDropdown);
        
        return customSelectContainer;
    }

    function selectOptionAdditional(selectId, value, text) {
        // Check for duplicates before selection
        const selectedValues = [];
        const mainService = document.getElementById('id_usluga').value;
        if (mainService) selectedValues.push(mainService);
        
        // Get all other additional services
        const otherSelects = document.querySelectorAll('[id^="dodatna_usluga_"]:not(#' + selectId + ')');
        otherSelects.forEach(select => {
            if (select.value) selectedValues.push(select.value);
        });
        
        // Check if this value is already selected
        if (selectedValues.includes(value)) {
            const serviceName = window.uslugeData[value]?.name || 'Unknown';
            alert(`Usluga "${serviceName}" je već izabrana. Molimo izaberite drugu uslugu.`);
            return;
        }
        
        // Update hidden select
        const hiddenSelect = document.getElementById(selectId);
        hiddenSelect.value = value;
        
        // Update visible text
        const selectedSpan = document.getElementById(selectId + '-selected');
        selectedSpan.textContent = text;
        selectedSpan.classList.add('selected');
        
        // Remove any error styling
        const trigger = document.getElementById(selectId + '-trigger');
        trigger.classList.remove('error');
        
        // Close dropdown using the new function
        closeDropdown(selectId);
        
        // Trigger change event
        const event = new Event('change', { bubbles: true });
        hiddenSelect.dispatchEvent(event);
    }

    function dodajUsluguSelect() {
        if (dodatneUslugeCount >= MAX_DODATNE_USLUGE) {
            alert('Možete dodati maksimalno 3 dodatne usluge.');
            return;
        }

        dodatneUslugeCount++;
        
        const container = document.getElementById('dodatne-usluge-container');
        const glavniSelect = document.getElementById('id_usluga');
        const selectId = `dodatna_usluga_${dodatneUslugeCount}`;
        
        // Kreiraj div wrapper za dodatnu uslugu
        const wrapperDiv = document.createElement('div');
        wrapperDiv.className = 'dodatna-usluga-wrapper';
        wrapperDiv.style.marginTop = '15px';
        wrapperDiv.id = `dodatna-usluga-${dodatneUslugeCount}`;
        
        // Kreiraj label
        const label = document.createElement('label');
        label.textContent = `Dodatna usluga ${dodatneUslugeCount}:`;
        label.style.display = 'block';
        label.style.marginBottom = '8px';
        label.style.fontWeight = '500';
        
        // Kreiraj row div za select i dugme
        const rowDiv = document.createElement('div');
        rowDiv.style.display = 'flex';
        rowDiv.style.alignItems = 'flex-start';
        rowDiv.style.gap = '10px';
        
        // Create hidden select for form submission
        const hiddenSelect = document.createElement('select');
        hiddenSelect.name = `dodatna_usluga_${dodatneUslugeCount}`;
        hiddenSelect.id = selectId;
        hiddenSelect.style.display = 'none';
        hiddenSelect.innerHTML = glavniSelect.innerHTML;
        hiddenSelect.addEventListener('change', azurirajCene);
        
        // Create custom select
        const customSelect = createCustomSelectForAdditional(selectId);
        
        // Kreiraj dugme za uklanjanje
        const ukloniBtn = document.createElement('button');
        ukloniBtn.type = 'button';
        ukloniBtn.className = 'btn btn-outline-danger btn-sm';
        ukloniBtn.innerHTML = '<i class="fa fa-minus"></i>';
        ukloniBtn.style.height = '56px'; // Match select height
        ukloniBtn.onclick = function() {
            ukloniDodatnuUslugu(dodatneUslugeCount);
        };
        
        // Sastavi elemente
        rowDiv.appendChild(hiddenSelect);
        rowDiv.appendChild(customSelect);
        rowDiv.appendChild(ukloniBtn);
        wrapperDiv.appendChild(label);
        wrapperDiv.appendChild(rowDiv);
        container.appendChild(wrapperDiv);
        
        azurirajDugme();
        azurirajCene(); // Update prices when new service is added
    }

    function ukloniDodatnuUslugu(id) {
        const element = document.getElementById(`dodatna-usluga-${id}`);
        if (element) {
            element.remove();
            // Prebroji postojeće dodatne usluge
            const postojece = document.querySelectorAll('.dodatna-usluga-wrapper');
            dodatneUslugeCount = postojece.length;
            azurirajDugme();
            azurirajCene(); // Update prices when service is removed
        }
    }

    function azurirajDugme() {
        const dugme = document.getElementById('dodaj-uslugu-btn');
        if (dodatneUslugeCount >= MAX_DODATNE_USLUGE) {
            dugme.style.display = 'none';
        } else {
            dugme.style.display = 'inline-block';
        }
    }

    // Add date validation for 30-day limit and initialize price system
    document.addEventListener('DOMContentLoaded', function() {
        const dateInput = document.getElementById('datum');
        
        dateInput.addEventListener('input', function() {
            const selectedDate = new Date(this.value);
            const today = new Date();
            const maxDate = new Date();
            maxDate.setDate(today.getDate() + 30);
            
            if (selectedDate > maxDate) {
                alert('Možete zakazati termin maksimalno 30 dana unapred. Molimo izaberite raniji datum.');
                this.value = '';
            }
        });
        
        // Initialize service data and price system
        inicijalizujUslugeData();
        
        // Add event listener to main service select
        const glavnaUslugaSelect = document.getElementById('id_usluga');
        if (glavnaUslugaSelect) {
            glavnaUslugaSelect.addEventListener('change', pokaziDodajUsluguDugme);
        }
    });

    // Custom Select Dropdown Functions
    function toggleDropdown(type) {
        const dropdown = document.getElementById(type + '-dropdown');
        const backdrop = document.getElementById(type + '-backdrop');
        const trigger = document.getElementById(type + '-trigger');
        const arrow = trigger.querySelector('.custom-select-arrow i');
        
        // Close all other dropdowns first
        closeAllDropdowns();
        
        // Toggle current dropdown
        if (dropdown.classList.contains('open')) {
            closeDropdown(type);
        } else {
            openDropdown(type);
        }
    }

    function openDropdown(type) {
        const dropdown = document.getElementById(type + '-dropdown');
        const backdrop = document.getElementById(type + '-backdrop');
        const trigger = document.getElementById(type + '-trigger');
        const arrow = trigger.querySelector('.custom-select-arrow i');
        
        dropdown.classList.add('open');
        backdrop.classList.add('active');
        arrow.classList.remove('fa-chevron-down');
        arrow.classList.add('fa-chevron-up');
        
        // Disable body scroll
        document.body.style.overflow = 'hidden';
    }

    function closeDropdown(type) {
        const dropdown = document.getElementById(type + '-dropdown');
        const backdrop = document.getElementById(type + '-backdrop');
        const trigger = document.getElementById(type + '-trigger');
        const arrow = trigger.querySelector('.custom-select-arrow i');
        
        dropdown.classList.remove('open');
        backdrop.classList.remove('active');
        arrow.classList.remove('fa-chevron-up');
        arrow.classList.add('fa-chevron-down');
        
        // Re-enable body scroll
        document.body.style.overflow = '';
    }

    function closeAllDropdowns() {
        document.querySelectorAll('.custom-select-dropdown').forEach(dropdown => {
            dropdown.classList.remove('open');
        });
        document.querySelectorAll('.custom-select-backdrop').forEach(backdrop => {
            backdrop.classList.remove('active');
        });
        document.querySelectorAll('.custom-select-arrow i').forEach(arrow => {
            arrow.classList.remove('fa-chevron-up');
            arrow.classList.add('fa-chevron-down');
        });
        document.body.style.overflow = '';
    }

    function selectOption(type, value, text) {
        // Update hidden select
        const hiddenSelect = document.getElementById('id_' + type);
        hiddenSelect.value = value;
        
        // Update visible text
        const selectedSpan = document.getElementById(type + '-selected');
        selectedSpan.textContent = text;
        selectedSpan.classList.add('selected');
        
        // Close dropdown using the new function
        closeDropdown(type);
        
        // Trigger change event for existing functionality
        const event = new Event('change', { bubbles: true });
        hiddenSelect.dispatchEvent(event);
        
        // For usluga, trigger the dodatne usluge functionality
        if (type === 'usluga') {
            pokaziDodajUsluguDugme();
        }
    }

    // Close dropdowns when pressing Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeAllDropdowns();
        }
    });

    // Form validation to ensure no empty additional services
    function validateAdditionalServices() {
        // Get only the wrapper elements (not individual selects)
        const additionalWrappers = document.querySelectorAll('.dodatna-usluga-wrapper');
        const emptySelects = [];
        const selectedValues = [];
        const duplicates = [];
        
        // Get main service value
        const mainService = document.getElementById('id_usluga').value;
        if (mainService) {
            selectedValues.push(mainService);
        }
        
        additionalWrappers.forEach((wrapper, index) => {
            const selectId = wrapper.id.replace('dodatna-usluga-', '');
            const select = document.getElementById(`dodatna_usluga_${selectId}`);
            
            if (select) {
                const value = select.value;
                const selectNumber = parseInt(selectId);
                
                // Check for empty selections
                if (!value) {
                    emptySelects.push(selectNumber);
                } else {
                    // Check for duplicates
                    if (selectedValues.includes(value)) {
                        duplicates.push({
                            number: selectNumber,
                            serviceName: window.uslugeData[value]?.name || 'Unknown'
                        });
                    } else {
                        selectedValues.push(value);
                    }
                }
            }
        });
        
        // Clear previous error states
        document.querySelectorAll('.custom-select-trigger').forEach(trigger => {
            trigger.classList.remove('error');
        });
        
        // Show validation errors
        if (emptySelects.length > 0) {
            // Highlight empty selects
            emptySelects.forEach(selectNumber => {
                const trigger = document.querySelector(`#dodatna_usluga_${selectNumber}-trigger`);
                if (trigger) trigger.classList.add('error');
            });
            
            alert(`Molimo izaberite uslugu za dodatne usluge: ${emptySelects.join(', ')}`);
            return false;
        }
        
        if (duplicates.length > 0) {
            // Highlight duplicate selects
            duplicates.forEach(duplicate => {
                const trigger = document.querySelector(`#dodatna_usluga_${duplicate.number}-trigger`);
                if (trigger) trigger.classList.add('error');
            });
            
            const duplicateMessages = duplicates.map(d => 
                `Dodatna usluga ${d.number} (${d.serviceName})`
            );
            alert(`Jedna te iste usluge ne možete izabrati više puta:\n${duplicateMessages.join('\n')}`);
            return false;
        }
        
        return true;
    }

    // Add validation to form submission
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('#prva-forma form');
        if (form) {
            form.addEventListener('submit', function(e) {
                if (!validateAdditionalServices()) {
                    e.preventDefault();
                }
            });
        }
    });

</script>

<!-- Custom Select Styles -->
<style>
    .custom-select-container {
        position: relative;
        width: 100%;
        margin-bottom: 15px;
    }

    .custom-select-trigger {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 16px 20px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        min-height: 56px;
    }

    .custom-select-trigger:hover {
        border-color: #007bff;
        box-shadow: 0 4px 8px rgba(0,123,255,0.15);
    }

    .custom-select-trigger.active {
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0,123,255,0.25);
    }

    .custom-select-arrow {
        color: #666;
        transition: color 0.3s ease;
    }

    .custom-select-trigger:hover .custom-select-arrow {
        color: #007bff;
    }

    .custom-select-dropdown {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border: 1px solid #ddd;
        border-radius: 12px;
        width: 90vw;
        max-width: 800px;
        height: 95vh;
        max-height: 95vh;
        overflow-y: auto;
        z-index: 9999;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .custom-select-dropdown.open {
        opacity: 1;
        visibility: visible;
        transform: translate(-50%, -50%) scale(1);
    }

    .custom-select-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9998;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }

    .custom-select-backdrop.active {
        opacity: 1;
        visibility: visible;
    }

    .dropdown-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        border-bottom: 2px solid #f0f0f0;
        background: #f8f9fa;
        border-radius: 12px 12px 0 0;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .dropdown-title {
        font-size: 1.3em;
        font-weight: 600;
        color: #333;
        margin: 0;
    }

    .dropdown-close {
        background: none;
        border: none;
        font-size: 1.8em;
        color: #666;
        cursor: pointer;
        padding: 5px;
        border-radius: 50%;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
    }

    .dropdown-close:hover {
        background: rgba(0,0,0,0.1);
        color: #333;
    }

    .custom-select-option {
        padding: 20px 18px;
        cursor: pointer;
        transition: all 0.2s ease;
        border-bottom: 1px solid #f5f5f5;
    }

    .custom-select-option:last-child {
        border-bottom: none;
    }

    .custom-select-option:hover {
        background-color: #f8f9fa;
        transform: translateX(2px);
    }

    .custom-select-option:active {
        background-color: #e9ecef;
    }

    .option-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
    }

    .option-left {
        display: flex;
        align-items: center;
        flex: 1;
    }

    .option-right {
        display: flex;
        align-items: center;
        flex-shrink: 0;
    }

    .option-avatar {
        width: 50px;
        height: 50px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 16px;
        flex-shrink: 0;
    }

    .service-avatar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-size: 20px;
    }

    .barber-avatar {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        font-weight: 600;
        font-size: 18px;
    }

    .avatar-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 8px;
    }

    .avatar-initials {
        font-weight: 700;
        letter-spacing: 0.5px;
    }

    .option-info {
        display: flex;
        flex-direction: column;
        flex: 1;
    }

    .option-name {
        font-weight: 600;
        color: #333;
        font-size: 1.1em;
        margin-bottom: 4px;
        line-height: 1.2;
    }

    .option-duration,
    .option-status {
        font-size: 0.95em;
        color: #666;
        font-weight: 400;
        line-height: 1.3;
    }

    .option-price {
        color: #28a745;
        font-weight: 700;
        font-size: 1.05em;
        background: rgba(40, 167, 69, 0.1);
        padding: 8px 12px;
        border-radius: 8px;
        min-width: 80px;
        text-align: center;
    }

    .option-badge {
        padding: 6px 12px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        min-width: 60px;
        text-align: center;
    }

    .barber-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .admin-badge {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
    }

    #usluga-selected.selected,
    #frizer-selected.selected {
        color: #333;
        font-weight: 500;
    }

    /* Error states */
    .custom-select-trigger.error {
        border-color: #dc3545 !important;
        box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.25) !important;
    }

    .custom-select-trigger.error .custom-select-arrow {
        color: #dc3545 !important;
    }

    /* Custom scrollbar for dropdown */
    .custom-select-dropdown::-webkit-scrollbar {
        width: 6px;
    }

    .custom-select-dropdown::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }

    .custom-select-dropdown::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }

    .custom-select-dropdown::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }

    /* Loyalty Info Styling */
    .loyalty-info-container {
        text-align: center;
        margin: 2rem 0;
    }
    
    .loyalty-badge {
        display: inline-block;
        padding: 1.5rem 2.5rem;
        border-radius: 20px;
        font-weight: 800;
        font-size: 1.6rem;
        text-align: center;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        margin: 0 auto;
        max-width: 95%;
        line-height: 1.5;
        letter-spacing: 0.5px;
    }
    
    .loyalty-badge.free-next {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        border: 3px solid #34d399;
        animation: celebration-pulse 2s infinite;
    }
    
    .loyalty-badge.almost-free {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
        border: 3px solid #fbbf24;
        animation: excitement-pulse 1.5s infinite;
    }
    
    .loyalty-badge.regular {
        background: linear-gradient(135deg, #3b82f6, #1e40af);
        color: white;
        border: 3px solid #60a5fa;
    }
    
    @keyframes celebration-pulse {
        0%, 100% {
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            transform: scale(1);
        }
        50% {
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.5);
            transform: scale(1.02);
        }
    }
    
    @keyframes excitement-pulse {
        0%, 100% {
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }
        50% {
            box-shadow: 0 6px 18px rgba(245, 158, 11, 0.5);
        }
    }


    /* Mobile responsive - Make everything BIGGER for touch */
    @media (max-width: 768px) {
        .loyalty-badge {
            font-size: 1.8rem;
            padding: 2rem 2rem;
            border-radius: 24px;
            max-width: 98%;
            line-height: 1.4;
        }
        
        .custom-select-trigger {
            padding: 20px 18px;
            min-height: 64px;
        }
        
        .custom-select-option {
            padding: 24px 18px;
        }
        
        .option-avatar {
            width: 55px;
            height: 55px;
            margin-right: 16px;
        }
        
        .service-avatar {
            font-size: 22px;
        }
        
        .barber-avatar {
            font-size: 20px;
        }
        
        .option-name {
            font-size: 1.2em;
            margin-bottom: 6px;
        }
        
        .option-duration,
        .option-status {
            font-size: 1em;
        }
        
        .option-price {
            font-size: 1.1em;
            padding: 10px 14px;
            min-width: 90px;
        }
        
        .option-badge {
            font-size: 0.85em;
            padding: 8px 12px;
            min-width: 70px;
        }
        
        /* Make dropdown arrows bigger on mobile */
        .custom-select-arrow {
            font-size: 1.2em;
        }
        
        /* Increase selected text size */
        .custom-select-trigger span {
            font-size: 1.1em;
        }
        
        /* Make remove buttons bigger on mobile */
        .btn-outline-danger {
            min-height: 64px !important;
            padding: 12px 16px !important;
            font-size: 1.1em !important;
        }
    }
</style>

{% endblock %}
