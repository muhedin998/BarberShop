{% extends "appointment/base.html" %}
{% block content %}
<br>
<br>
<br>
<br>
<h3 class="w3-center">ZAKAZIVANJE TERMINA </h3><br>
{% if messages %}

    {% for message in messages %}
    <p class="w3-center p-2 text-white bg-opacity-75 fs-1 bg-{{ message.tags }}">{{ message }}</p>
    {% endfor %}

{% endif %}

    <h2 class="w3-center bg-danger text-white my-3 px-3">{{ termin_counter   }}</h2>

    <div class="mb-3 row justify-content-center ">
    <br>

    <br>
    <div class="col-md-auto col-sm-auto col-lg-4 shadow-lg p-3 mb-5 bg-body rounded {% if viewname != "termin" %}w3-hide{% endif %}" id="prva-forma" >

        <form method="post" class="w3-margin">
            {% csrf_token %}
            <label>Glavna usluga: </label>
            <select class='w3-select' name="usluga" required="required" id="id_usluga" style="-webkit-appearance: none;" onchange="pokaziDodajUsluguDugme()">
                <option selected disabled value=""></option>
                {% with value=form.usluga.value %}
                {% for value in form.usluga.field.choices.queryset %}
                <option title="{{value}}" value="{{ value.id }}"{% if value.id == 15 or value.id == 14 or value.id == 13 %}disabled{% endif %}>{{ value }}</option>
                {% endfor %}
                {% endwith %}
                </select>
                
                <div id="dodaj-uslugu-section" style="display: none; margin-top: 15px;">
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="dodaj-uslugu-btn" onclick="dodajUsluguSelect()">
                        <i class="fa fa-plus"></i> Dodaj dodatnu uslugu
                    </button>
                </div>
                
                <div id="dodatne-usluge-container">
                    <!-- Dodatni select-ovi za usluge će se dodavati ovde -->
                </div>
                
                <div id="cene-pregled" style="display: none; margin-top: 15px; background-color: #f8f9fa; padding: 10px; border-radius: 5px;">
                    <strong>Pregled cena:</strong>
                    <div id="glavna-usluga-cena"></div>
                    <div id="dodatne-usluge-cene"></div>
                    <hr style="margin: 10px 0;">
                    <div id="ukupna-cena" style="font-weight: bold; color: #007bff;"></div>
                </div>
                <br>
                <label><br>Izaberite frizera: </label>
                <select class='w3-select' name="frizer" required="required" id="id_frizer" style="-webkit-appearance: none;">
                    <option selected disabled value=""></option>
                    {% with value=form.frizer.value %}
                    {% for value in form.frizer.field.choices.queryset %}
                        {% if value.id == 4 %}
                            {% if user.is_superuser %}
                                <option title="{{ value }}" value="{{ value.id }}">{{ value }}</option>
                            {% endif %}
                        {% else %}
                            <option title="{{ value }}" value="{{ value.id }}">{{ value }}</option>
                        {% endif %}
                    {% endfor %}
                    {% endwith %}
                </select>
                <label><br>Izaberite datum: </label><br>
                <input required style=" padding: 20 5; width: 100%; margin-bottom: 4px;" class="w3-select" type="date" name="datum" id="datum" min="{{ min_date }}" max="{{ max_date }}" style="border: none; "><br>
                <small class="text-muted">Možete zakazati termin maksimalno 30 dana unapred</small><br><br>
                
                
            <button class="btn btn-secondary"  name="form_filter_button"  id="first_form_button" style="-webkit-appearance: none;">Izaberite termin <i class="fa fa-arrow-right"></i></button>
        </form>
        <br>

    </div>

    <div class="col-md-auto col-sm-auto col-lg-4 shadow-lg p-3 mb-5 bg-body rounded {% if viewname != "potvrdi" %}w3-hide{% endif %}" id="druga-forma">
        <form class="w3-margin" action="" method="post" id="potvrdi-form">


            {% csrf_token %}
            {% if user.is_superuser %} 
                <label>Ime i Prezime: </label><br>
                <input required style=" padding: 20 5; width: 100%; margin-bottom: 4px;" class="w3-select" type="text" name="name" >

                <label>Broj telefona: </label><br>
                <input required style=" padding: 20 5; width: 100%; margin-bottom: 4px;" class="w3-select" type="text" name="broj_telefona" > 
            {% endif %}

            {% if has_multiple_services %}
            <div class="alert alert-info">
                <strong>Odabrane usluge:</strong>
                <ul style="margin-bottom: 10px;">
                {% for service in all_services %}
                    <li>
                        {% if service.is_main %}
                            <strong>{{ service.name }}</strong> (glavna) - {{ service.price }} RSD
                        {% else %}
                            {{ service.name }} (dodatna) - {{ service.price }} RSD
                        {% endif %}
                    </li>
                {% endfor %}
                </ul>
                <small class="text-muted">Vreme termina se računa samo za glavnu uslugu.</small>
            </div>
            {% elif glavna_usluga_info %}
            <div class="alert alert-info">
                <strong>Odabrana usluga:</strong> {{ glavna_usluga_info.name }} - {{ glavna_usluga_info.cena }} RSD
            </div>
            {% endif %}
            
            {% if ukupna_cena %}
            <div class="alert alert-success">
                <strong>Ukupna cena termina: {{ ukupna_cena }} RSD</strong>
            </div>
            {% endif %}
            
            <label>Izaberite termin: </label><br>
            {{ form.vreme }}
            <label class="mt-2">Ostavite poruku: <span style="opacity: 0.5;">(opciono)</span></label><br>
            
            {{ form.poruka }}
            <br>
            <div class="row mt-3">
            <div class="col">
            <input style=" padding: 20 5; width: 100%; margin-bottom: 4px;" class="btn btn-success" name="zakazi_termin" type="submit" value="ZAKAŽI">
            </div>
            <div class="col">
            <a href="{% url 'termin' %}" class="btn"> <i class="fa fa-arrow-left"> </i> Izmena unosa</a>
            </div>
            </div>
        </form>
        <div style="display:none;" id="nema-termina">
            <h1 class="bg-secondary w3-padding text-white" >Nema dostupnih termina za ovaj dan !</h1>
            <br>
            <a href="{% url 'termin' %}" class="btn btn-secondary"> <i class="fa fa-arrow-left"> </i> Promeni datum</a>
        </div>
  </div>
</div>
<br><br><br>

<script>
    const picker = document.getElementById('datum');
    picker.addEventListener('input', function(e){
        var day = new Date(this.value).getUTCDay();
        if([5].includes(day)){
            e.preventDefault();
            picker.value = getNextMonday(this.value).toISOString().substring(0,10);
            alert('Petkom ne radimo ! \n');
        }
    });

    function getNextMonday(value) {
        date = new Date(value)
        const dateCopy = new Date(date.getTime());

        const nextMonday = new Date(dateCopy.setDate(dateCopy.getDate() + 1));
        return nextMonday;
    }

    let dodatneUslugeCount = 0;
    const MAX_DODATNE_USLUGE = 3;
    let uslugeData = {}; // Object to store service data (id -> {name, price})

    // Initialize service data from the select options
    function inicijalizujUslugeData() {
        const glavniSelect = document.getElementById('id_usluga');
        const options = glavniSelect.querySelectorAll('option[value]');
        
        options.forEach(option => {
            if (option.value) {
                const fullText = option.textContent.trim();
                const parts = fullText.split(' - ');
                if (parts.length >= 2) {
                    const name = parts[0];
                    const price = parseInt(parts[1]) || 0;
                    uslugeData[option.value] = { name: name, price: price };
                }
            }
        });
    }

    // Update price display
    function azurirajCene() {
        const glavnaUsluga = document.getElementById('id_usluga').value;
        const cenePregled = document.getElementById('cene-pregled');
        const glavnaUslugaCena = document.getElementById('glavna-usluga-cena');
        const dodatneUslugeCene = document.getElementById('dodatne-usluge-cene');
        const ukupnaCena = document.getElementById('ukupna-cena');
        
        if (!glavnaUsluga || !cenePregled) {
            if (cenePregled) cenePregled.style.display = 'none';
            return;
        }
        
        let ukupno = 0;
        let hasAdditionalServices = false;
        
        // Display main service price
        if (uslugeData[glavnaUsluga]) {
            glavnaUslugaCena.innerHTML = `<strong>Glavna usluga:</strong> ${uslugeData[glavnaUsluga].name} - ${uslugeData[glavnaUsluga].price} RSD`;
            ukupno += uslugeData[glavnaUsluga].price;
        }
        
        // Display additional services prices
        dodatneUslugeCene.innerHTML = '';
        const dodatneUslugeSelects = document.querySelectorAll('[id^=\"dodatna_usluga_\"]');
        let additionalServicesHTML = '';
        
        dodatneUslugeSelects.forEach((select, index) => {
            if (select.value && uslugeData[select.value]) {
                additionalServicesHTML += `<div>Dodatna usluga ${index + 1}: ${uslugeData[select.value].name} - ${uslugeData[select.value].price} RSD</div>`;
                ukupno += uslugeData[select.value].price;
                hasAdditionalServices = true;
            }
        });
        
        if (hasAdditionalServices) {
            dodatneUslugeCene.innerHTML = '<strong>Dodatne usluge:</strong><br>' + additionalServicesHTML;
        }
        
        // Display total with emphasis
        ukupnaCena.innerHTML = `<strong style="color: #28a745; font-size: 1.1em;">UKUPNA CENA: ${ukupno} RSD</strong>`;
        cenePregled.style.display = ukupno > 0 ? 'block' : 'none';
    }

    function pokaziDodajUsluguDugme() {
        const glavnaUsluga = document.getElementById('id_usluga').value;
        const dugmeSection = document.getElementById('dodaj-uslugu-section');
        
        if (glavnaUsluga) {
            dugmeSection.style.display = 'block';
        } else {
            dugmeSection.style.display = 'none';
            // Ukloni sve dodatne usluge ako se glavna usluga promeni
            const container = document.getElementById('dodatne-usluge-container');
            container.innerHTML = '';
            dodatneUslugeCount = 0;
            azurirajDugme();
        }
        azurirajCene(); // Update prices when main service changes
    }

    function dodajUsluguSelect() {
        if (dodatneUslugeCount >= MAX_DODATNE_USLUGE) {
            alert('Možete dodati maksimalno 3 dodatne usluge.');
            return;
        }

        dodatneUslugeCount++;
        
        const container = document.getElementById('dodatne-usluge-container');
        const glavniSelect = document.getElementById('id_usluga');
        
        // Kreiraj div wrapper za dodatnu uslugu
        const wrapperDiv = document.createElement('div');
        wrapperDiv.className = 'dodatna-usluga-wrapper';
        wrapperDiv.style.marginTop = '10px';
        wrapperDiv.id = `dodatna-usluga-${dodatneUslugeCount}`;
        
        // Kreiraj label
        const label = document.createElement('label');
        label.textContent = `Dodatna usluga ${dodatneUslugeCount}:`;
        
        // Kreiraj row div za select i dugme
        const rowDiv = document.createElement('div');
        rowDiv.style.display = 'flex';
        rowDiv.style.alignItems = 'center';
        rowDiv.style.gap = '10px';
        
        // Kreiraj select element
        const select = document.createElement('select');
        select.className = 'w3-select';
        select.name = `dodatna_usluga_${dodatneUslugeCount}`;
        select.id = `dodatna_usluga_${dodatneUslugeCount}`;
        select.style.webkitAppearance = 'none';
        select.style.flex = '1';
        
        // Dodaj opcije iz glavnog select-a
        select.innerHTML = glavniSelect.innerHTML;
        
        // Add event listener for price updates
        select.addEventListener('change', azurirajCene);
        
        // Kreiraj dugme za uklanjanje
        const ukloniBtn = document.createElement('button');
        ukloniBtn.type = 'button';
        ukloniBtn.className = 'btn btn-outline-danger btn-sm';
        ukloniBtn.innerHTML = '<i class="fa fa-minus"></i>';
        ukloniBtn.onclick = function() {
            ukloniDodatnuUslugu(dodatneUslugeCount);
        };
        
        // Sastavi elemente
        rowDiv.appendChild(select);
        rowDiv.appendChild(ukloniBtn);
        wrapperDiv.appendChild(label);
        wrapperDiv.appendChild(rowDiv);
        container.appendChild(wrapperDiv);
        
        azurirajDugme();
        azurirajCene(); // Update prices when new service is added
    }

    function ukloniDodatnuUslugu(id) {
        const element = document.getElementById(`dodatna-usluga-${id}`);
        if (element) {
            element.remove();
            // Prebroji postojeće dodatne usluge
            const postojece = document.querySelectorAll('.dodatna-usluga-wrapper');
            dodatneUslugeCount = postojece.length;
            azurirajDugme();
            azurirajCene(); // Update prices when service is removed
        }
    }

    function azurirajDugme() {
        const dugme = document.getElementById('dodaj-uslugu-btn');
        if (dodatneUslugeCount >= MAX_DODATNE_USLUGE) {
            dugme.style.display = 'none';
        } else {
            dugme.style.display = 'inline-block';
        }
    }

    // Add date validation for 30-day limit and initialize price system
    document.addEventListener('DOMContentLoaded', function() {
        const dateInput = document.getElementById('datum');
        
        dateInput.addEventListener('input', function() {
            const selectedDate = new Date(this.value);
            const today = new Date();
            const maxDate = new Date();
            maxDate.setDate(today.getDate() + 30);
            
            if (selectedDate > maxDate) {
                alert('Možete zakazati termin maksimalno 30 dana unapred. Molimo izaberite raniji datum.');
                this.value = '';
            }
        });
        
        // Initialize service data and price system
        inicijalizujUslugeData();
        
        // Add event listener to main service select
        const glavnaUslugaSelect = document.getElementById('id_usluga');
        if (glavnaUslugaSelect) {
            glavnaUslugaSelect.addEventListener('change', pokaziDodajUsluguDugme);
        }
    });

</script>

{% endblock %}
