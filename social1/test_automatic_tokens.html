<!DOCTYPE html>
<html>
<head>
    <title>Test Automatic Token Generation</title>
    <meta name="user-authenticated" content="true">
    <meta name="csrf-token" content="test-token">
</head>
<body class="authenticated">
    <h1>Automatic Token Generation Test</h1>
    
    <div id="status">
        <h3>Status</h3>
        <p><strong>Notification Permission:</strong> <span id="permission-status">Checking...</span></p>
        <p><strong>FCM Manager:</strong> <span id="fcm-status">Checking...</span></p>
        <p><strong>Auto Token Generation:</strong> <span id="auto-status">Checking...</span></p>
        <p><strong>Current Token:</strong> <span id="token-status">None</span></p>
    </div>
    
    <div>
        <button onclick="checkStatus()">Refresh Status</button>
        <button onclick="clearToken()">Clear Token (for testing)</button>
        <button onclick="reinitialize()">Reinitialize Handler</button>
    </div>
    
    <div id="log" style="background: #f0f0f0; padding: 10px; font-family: monospace; height: 300px; overflow-y: auto; margin-top: 20px;"></div>

    <!-- Load the actual scripts -->
    <script src="/static/appointment/js/firebase-config.js"></script>
    <script src="/static/appointment/js/notification-permission.js"></script>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function updateStatus() {
            // Permission status
            const permission = Notification.permission;
            document.getElementById('permission-status').textContent = permission;
            
            // FCM Manager status
            const fcmText = window.fcmManager ? 
                `Loaded (Initialized: ${window.fcmManager.isInitialized})` : 'Not loaded';
            document.getElementById('fcm-status').textContent = fcmText;
            
            // Token status
            const tokenText = (window.fcmManager && window.fcmManager.currentToken) ? 
                window.fcmManager.currentToken.substring(0, 30) + '...' : 'None';
            document.getElementById('token-status').textContent = tokenText;
            
            // Auto generation status
            const handlerExists = typeof window.notificationPermissionHandler !== 'undefined';
            document.getElementById('auto-status').textContent = handlerExists ? 'Handler loaded' : 'Handler not loaded';
        }

        function checkStatus() {
            log('=== Status Check ===');
            updateStatus();
            
            log(`Permission: ${Notification.permission}`);
            log(`FCM Manager exists: ${!!window.fcmManager}`);
            log(`FCM Manager initialized: ${window.fcmManager ? window.fcmManager.isInitialized : 'N/A'}`);
            log(`Current token: ${window.fcmManager && window.fcmManager.currentToken ? 'EXISTS' : 'NONE'}`);
            log(`Notification handler: ${typeof window.notificationPermissionHandler !== 'undefined' ? 'LOADED' : 'NOT LOADED'}`);
        }

        function clearToken() {
            log('Clearing FCM token for testing...');
            if (window.fcmManager) {
                window.fcmManager.currentToken = null;
                log('Token cleared');
                updateStatus();
            }
        }

        function reinitialize() {
            log('Reinitializing notification handler...');
            try {
                window.notificationPermissionHandler = new NotificationPermissionHandler();
                log('Notification handler reinitialized');
                updateStatus();
            } catch (error) {
                log(`Error reinitializing: ${error.message}`);
            }
        }

        // Track when things happen
        document.addEventListener('DOMContentLoaded', () => {
            log('Page loaded, waiting for initialization...');
            updateStatus();
        });

        window.addEventListener('fcmReady', () => {
            log('FCM ready event received');
            updateStatus();
        });

        // Check status periodically
        setInterval(updateStatus, 2000);
    </script>
</body>
</html>